user nobody;
worker_processes auto;

events { 
    worker_connections 4096;
}

http {
    include /usr/local/openresty/nginx/conf/mime.types;

    default_type application/json;

    # Logging
    log_format main '$remote_addr - $request_id [$time_local] '
                '"$request" $status $body_bytes_sent '
                '"$http_user_agent"';

    access_log /usr/local/openresty/nginx/logs/access.log main;
    error_log /usr/local/openresty/nginx/logs/error.log warn;


    sendfile on;
    keepalive_timeout 65;

    # Rate limit zones
    limit_req_zone $binary_remote_addr zone=api_limit:20m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:20m;

    # Upstream
    upstream auth_service {
        server authentication:8080 max_fails=3 fail_timeout=10s;
    }

    # upstream customer_service {
    #     server customer-service:8080 max_fails=3 fail_timeout=10s;
    # }

    # upstream account_service {
    #     server account-service:8080 max_fails=3 fail_timeout=10s;
    # }

    # upstream audit_service {
    #     server audit-service:8080 max_fails=3 fail_timeout=10s;
    # }

    # upstream payment_service {
    #     server payment-service:8080 max_fails=3 fail_timeout=10s;
    # }

    # upstream card_service {
    #     server card-service:8080 max_fails=3 fail_timeout=10s;
    # }

    # upstream loan_service {
    #     server loan-service:8080 max_fails=3 fail_timeout=10s;
    # }

    # upstream savings_service {
    #     server savings-service:8080 max_fails=3 fail_timeout=10s;
    # }

    server {
        listen 443 ssl;
        server_name _;

        # TLS Config
        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # HSTS
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;

        # Security Headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # Global Rate limiting
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;

        # Health Check
        location /health {
            return 200 '{"status": "HEALTHY"}';
        }

        # Internal Authentication
        location /_auth {
            internal;
            proxy_pass http://authentication:8080/api/v1/auth/validate;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Content-Length "";
            proxy_pass_request_body off;
        }

        # Authentication Service
        location /auth/ {
            proxy_pass http://authentication:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # # Customer Service
        # location /customer/ {
        #     auth_request /_auth;
        #     proxy_pass http://customer-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }

        # # Account Service
        # location /account/ {
        #     auth_request /_auth;
        #     proxy_pass http://account-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }

        # # Audit Service
        # location /audit/ {
        #     auth_request /_auth;
        #     proxy_pass http://audit-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }

        # # Payment Service
        # location /payment/ {
        #     auth_request /_auth;
        #     proxy_pass http://payment-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }

        # # Card Service
        # location /cards/ {
        #     auth_request /_auth;
        #     proxy_pass http://card-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }

        # # Loan Service
        # location /loan/ {
        #     auth_request /_auth;
        #     proxy_pass http://loan-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }

        # # Savings Service
        # location /savings/ {
        #     auth_request /_auth;
        #     proxy_pass http://savings-service:8080/;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Request-ID $request_id;
        # }
    }

    server {
        listen 80;
        server_name _;
        return 301 https://$host$request_uri;
    }
}