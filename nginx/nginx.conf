user nginx;
worker_processes auto;

events { 
    worker_connections 4096;
}

http {
    include mime.types;
    default_type application/json;

    log_format '$remote_addr - $request_id [$time_local] '
                '"$request" $status $body_bytes_sent '
                '"$http_user_agent"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    keepalive_timeout 65;

    # Rate limit zones
    limit_req_zone $binary_remote_addr zone=api_limit:20m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:20m;

    server {
        listen 80;
        server_name _;

        # Security Headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # Global Rate limiting
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;

        # Health Check
        location /health {
            return 200 '{"status": "HEALTHY"}';
        }

        # Internal Authentication
        location /_auth {
            internal;
            proxy_pass http://auth-service:8080/api/v1/validate;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Content-Length "";
            proxy_pass_request_body off;
        }

        # Authentication Service
        location /auth/ {
            proxy_pass http://auth-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Customer Service
        location /customer/ {
            auth_request /_auth;
            proxy_pass http://customer-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Account Service
        location /account/ {
            auth_request /_auth;
            proxy_pass http://account-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Audit Service
        location /audit/ {
            auth_request /_auth;
            proxy_pass http://audit-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Payment Service
        location /payment/ {
            auth_request /_auth;
            proxy_pass http://payment-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Card Service
        location /cards/ {
            auth_request /_auth;
            proxy_pass http://card-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Loan Service
        location /loan/ {
            auth_request /_auth;
            proxy_pass http://loan-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-Ip $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }

        # Savings Service
        location /savings/ {
            auth_request /_auth;
            proxy_pass http://savings-service:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Request-ID $request_id;
        }
    }
}